import Koa from "koa";
import Router from "@koa/router";
import useQueryParser from "./useQueryParser";
import mount from "koa-mount";
import serve from "koa-static";
import { forEach } from "@frankycty/rm-extra";

const Server = {
  async start(routes = {}, staticPaths = [], { port = 4000 }) {
    const app = new Koa();

    // Set up query string parsing
    useQueryParser(app);

    // Load static paths
    forEach(({ route: staticRoute, path: staticPath }) => {
      app.use(mount(staticRoute, serve(staticPath)));
    }, staticPaths);

    // Register routes
    const koaRouter = new Router();

    const registerKoaRoutes = (koaRouter, routes) => {
      forEach(({ method, path, handler }) => {
        koaRouter[method](path, handler);
      }, routes);
    };

    registerKoaRoutes(koaRouter, routes);

    app.use(koaRouter.routes());

    app.listen(port, () => {
      console.log(`server started on localhost: ${port}`);
    });

    return app;
  },
};

export { Server };
