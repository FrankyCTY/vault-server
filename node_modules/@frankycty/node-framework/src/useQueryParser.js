import qs from "qs";
import merge from "merge-descriptors";
import { isNilOrEmpty } from "@frankycty/rm-extra";

export default (app) => {
  merge(app.request, {
    get query() {
      if (isNilOrEmpty(this.querystring)) return {};

      let cachedQuery = getCachedQuery(this, this.querystring);

      if (isNilOrEmpty(cachedQuery))
        cachedQuery = qs.parse(this.querystring, { comma: true });

      return cachedQuery;
    },

    set query(obj) {
      this.querystring = qs.stringify(obj);
    },
  });
};

function getCachedQuery({ _querycache: cache = {} }, querystring) {
  return cache[querystring];
}
